# chem_safety_app_v2.py
# ì‹¤í–‰: streamlit run chem_safety_app_v2.py

import streamlit as st
import itertools
import re

# =========================
# ë°ì´í„°(í‚¤ì›Œë“œ/ê·œì¹™/ì„¤ëª…)
# =========================
ALIASES = {
    "bleach": {"í‘œë°±ì œ", "ë½ìŠ¤", "ì°¨ì•„ì—¼ì†Œì‚°ë‚˜íŠ¸ë¥¨", "sodium hypochlorite", "hypochlorite"},
    "ammonia": {"ì•”ëª¨ë‹ˆì•„", "ammonia", "nh3"},
    "acid": {"ì‹ì´ˆ", "ì´ˆì‚°", "acetic acid", "êµ¬ì—°ì‚°", "citric acid", "ì—¼ì‚°", "hydrochloric acid", "hcl", "í™©ì‚°", "sulfuric acid"},
    "peroxide": {"ê³¼ì‚°í™”ìˆ˜ì†Œ", "hydrogen peroxide", "h2o2"},
    "alcohol": {"ì—íƒ„ì˜¬", "ethanol", "ipa", "isopropyl alcohol", "ì´ì†Œí”„ë¡œí•„ì•Œì½”ì˜¬", "ì†Œë…ìš© ì•Œì½”ì˜¬"},
    "quat": {"ë²¤ì˜ì½”ëŠ„ì—¼í™”ë¬¼", "benzalkonium chloride", "quat", "4ê¸‰ ì•”ëª¨ëŠ„ì—¼", "quaternary ammonium"},
    "baking_soda": {"ë² ì´í‚¹ì†Œë‹¤", "íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨", "sodium bicarbonate"},
}

HAZARDOUS_RULES = {
    frozenset({"bleach", "ammonia"}): ("â˜ ï¸ ë…ì„± ê°€ìŠ¤", "â€˜í‘œë°±ì œ+ì•”ëª¨ë‹ˆì•„â€™ í˜¼í•©ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤."),
    frozenset({"bleach", "acid"}): ("ğŸ« ì—¼ì†Œ ê°€ìŠ¤", "â€˜í‘œë°±ì œ+ì‚°(ì‹ì´ˆ/êµ¬ì—°ì‚°/ì—¼ì‚° ë“±)â€™ í˜¼í•©ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤."),
    frozenset({"bleach", "alcohol"}): ("ğŸ§  ì‹ ê²½ ë…ì„±", "â€˜í‘œë°±ì œ+ì•Œì½”ì˜¬â€™ í˜¼í•©ì€ ìœ„í—˜í•©ë‹ˆë‹¤."),
    frozenset({"peroxide", "acid"}): ("ğŸ§¯ ë¶€ì‹ì„±", "â€˜ê³¼ì‚°í™”ìˆ˜ì†Œ+ì‚°â€™ í˜¼í•©ì€ ìœ„í—˜í•©ë‹ˆë‹¤."),
    frozenset({"baking_soda", "acid"}): ("ğŸ’¥ ì••ë ¥ í­ë°œ", "â€˜ë² ì´í‚¹ì†Œë‹¤+ì‚°â€™ì€ ë°€í ìš©ê¸°ì—ì„œ ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."),
    frozenset({"bleach", "quat"}): ("âš ï¸ íš¨ê³¼ ì €í•˜", "â€˜í‘œë°±ì œ+4ê¸‰ì•”ëª¨ëŠ„(ì†Œë…ì œ)â€™ í˜¼í•©ì€ í”¼í•˜ì„¸ìš”."),
}

HAZ_DETAILS = {
    frozenset({"bleach", "ammonia"}): {
        "why": "ì„ìœ¼ë©´ â€˜í´ë¡œë¼ë¯¼â€™ ê°™ì€ ê°€ìŠ¤ê°€ ìƒê²¨ ëˆˆÂ·ì½” ìê·¹, ê¸°ì¹¨, í˜¸í¡ê³¤ë€ì„ ì¼ìœ¼í‚µë‹ˆë‹¤.",
        "symptoms": "ëˆˆÂ·ëª© ë”°ê°€ì›€, ê¸°ì¹¨, ë©”ìŠ¤êº¼ì›€, ìˆ¨ ê°€ì¨.",
        "instead": "í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. í‘œë°±ì œë¥¼ ì¼ë‹¤ë©´ ë¬¼ë¡œ í—¹êµ¬ê³  í™˜ê¸° í›„ ë‹¤ë¥¸ ë‚  ì•”ëª¨ë‹ˆì•„ ì œí’ˆì„ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "acid"}): {
        "why": "ì„ì´ë©´ â€˜ì—¼ì†Œ ê°€ìŠ¤(Clâ‚‚)â€™ê°€ ìƒê²¨ í˜¸í¡ê¸°ì— ì‹¬í•œ ìê·¹ì„ ì¤ë‹ˆë‹¤.",
        "symptoms": "ëˆˆë¬¼, ê¸°ì¹¨, ê°€ìŠ´ ë‹µë‹µ, í˜¸í¡ ê³¤ë€.",
        "instead": "í‘œë°±ì œì™€ ì‚° ê³„ì—´ì€ ì ˆëŒ€ í•¨ê»˜ ì“°ì§€ ë§ˆì„¸ìš”. í•„ìš”í•˜ë©´ ë‹¤ë¥¸ ë‚  ë”°ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "alcohol"}): {
        "why": "íŠ¹ì • ì¡°ê±´ì—ì„œ ë…ì„± ë¶€ì‚°ë¬¼(í´ë¡œë¡œí¬ë¦„ ë“±)ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ë‘í†µ, ì–´ì§€ëŸ¬ì›€, ë©”ìŠ¤êº¼ì›€.",
        "instead": "í‘œë°±ì œë¥¼ ì“°ëŠ” ë‚ ì—” ì•Œì½”ì˜¬ ì œí’ˆì€ í”¼í•˜ì„¸ìš”.",
    },
    frozenset({"peroxide", "acid"}): {
        "why": "â€˜ê³¼ì´ˆì‚°â€™ ê°™ì€ ê°•í•œ ìê·¹Â·ë¶€ì‹ì„± ë¬¼ì§ˆì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "í”¼ë¶€Â·ëˆˆ ìê·¹, í˜¸í¡ê¸° ìê·¹.",
        "instead": "ê³¼ì‚°í™”ìˆ˜ì†Œì™€ ì‚°ì„± ì œí’ˆì€ í•¨ê»˜ ì“°ì§€ ë§ê³  ê°ê° ë‹¨ë…ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"baking_soda", "acid"}): {
        "why": "ì´ì‚°í™”íƒ„ì†Œ(COâ‚‚)ê°€ ê¸‰ê²©íˆ ë°œìƒí•´ ë°€í ìš©ê¸°ì—ì„  ì••ë ¥ í­ë°œ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ë°€í ìƒíƒœì—ì„œ ìš©ê¸° íŒŒì†Â·íŠ€ê¹€ ìœ„í—˜.",
        "instead": "ë°€í ìš©ê¸°ì—ì„œ ì„ì§€ ë§ê³ , í†µí’ë˜ëŠ” ê³³ì—ì„œ ê°œë°© ìš©ê¸°ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "quat"}): {
        "why": "íš¨ê³¼ê°€ ë–¨ì–´ì§€ê±°ë‚˜ ì”ë¥˜ ë°˜ì‘ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ì‚´ê·  íš¨ê³¼ ì €í•˜, í‘œë©´ ì†ìƒ.",
        "instead": "í•œ ë²ˆì— í•˜ë‚˜ì˜ ì œí’ˆë§Œ ì‚¬ìš©í•˜ê³  ì‚¬ìš© í›„ ì¶©ë¶„íˆ í—¹êµ¬ì„¸ìš”.",
    },
}

SURFACE_GUIDE = {
    "ëŒ€ë¦¬ì„/ì„ì¬": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "ë¯¸ì˜¨ìˆ˜"],
        "ì£¼ì˜": ["ì‚°(ì‹ì´ˆ/êµ¬ì—°ì‚°)", "í‘œë°±ì œ"],
        "ë©”ëª¨": "ì„íšŒì§ˆì´ë¼ ì‚°ì— ì•½í•©ë‹ˆë‹¤. ë°˜ì Â·ë¶€ì‹ ìœ„í—˜.",
    },
    "ëª©ì¬": {
        "ê¶Œì¥": ["ì¤‘ì„±Â·ì•½ì•Œì¹¼ë¦¬ ì„¸ì œ", "ë§ˆë¥¸ì²œ", "ì†ŒëŸ‰ ì•Œì½”ì˜¬"],
        "ì£¼ì˜": ["ê³¼ë„í•œ ìˆ˜ë¶„", "ê°•ì‚°/ê°•ì•Œì¹¼ë¦¬"],
        "ë©”ëª¨": "ì½”íŒ… ì†ìƒÂ·ë³€ìƒ‰ ì£¼ì˜. ë¬¼ê¸°ëŠ” ë°”ë¡œ ë‹¦ì•„ì£¼ì„¸ìš”.",
    },
    "ìŠ¤í…Œì¸ë¦¬ìŠ¤": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "ì§§ê²Œ í¬ì„ í‘œë°±ì œ(ì´í›„ í—¹êµ¼)"],
        "ì£¼ì˜": ["ê°•ì‚°", "ì¥ì‹œê°„ í‘œë°±ì œ ì ‘ì´‰"],
        "ë©”ëª¨": "ì‚¬ìš© í›„ ì¶©ë¶„íˆ í—¹êµ¬ë©´ ì–¼ë£©Â·ë¶€ì‹ ì˜ˆë°©.",
    },
    "ìœ ë¦¬/íƒ€ì¼": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "í¬ì„ ì‚°(ë¹„ëˆ„ë•Œ ì œê±°)", "ì•Œì½”ì˜¬"],
        "ì£¼ì˜": ["í™˜ê¸° ë¶€ì¡± ì‹œ ì•”ëª¨ë‹ˆì•„ ê³¼ë‹¤ ì‚¬ìš©"],
        "ë©”ëª¨": "ê¸ˆì† ë¶€í’ˆ ë¶€ì‹ ì£¼ì˜, í™˜ê¸° í•„ìˆ˜.",
    },
}

# =========================
# í•¨ìˆ˜
# =========================
def normalize_token(token: str) -> set:
    """ì…ë ¥ê°’ì—ì„œ í•´ë‹¹í•˜ëŠ” í‚¤ì›Œë“œ ì§‘í•© ë°˜í™˜"""
    token = token.strip().lower()
    hits = set()
    for key, variants in ALIASES.items():
        for v in variants:
            if re.search(rf"\b{re.escape(v.lower())}\b", token):
                hits.add(key)
    if token in ALIASES.keys():
        hits.add(token)
    return hits

def check_mixture(items: list):
    """2ê°œ, 3ê°œ ì¡°í•© ëª¨ë‘ ì²´í¬"""
    keys = set()
    for raw in items:
        keys |= normalize_token(raw)
    messages, details = [], []
    for r in (2, 3):
        for combo in itertools.combinations(keys, r):
            combo_set = frozenset(combo)
            if combo_set in HAZARDOUS_RULES:
                cat, msg = HAZARDOUS_RULES[combo_set]
                messages.append((cat, msg))
                details.append(HAZ_DETAILS.get(combo_set))
    return keys, messages, details

def dilution_calc(c1, c2, v2):
    if c1 <= 0 or c2 <= 0 or v2 <= 0 or c2 >= c1:
        return None, None
    v1 = (c2 * v2) / c1
    solvent = v2 - v1
    return v1, solvent

# =========================
# UI
# =========================
st.set_page_config(page_title="í´ë¦°ë©”ì´íŠ¸", page_icon="ğŸ§¹")
st.title("ğŸ§¹ í´ë¦°ë©”ì´íŠ¸")

menu = st.sidebar.radio("ë©”ë‰´", ["í˜¼í•© ì•ˆì „ í™•ì¸", "í¬ì„ ê³„ì‚°", "í‘œë©´ë³„ ê°€ì´ë“œ"])

# -------------------------
# í˜¼í•© ì•ˆì „ í™•ì¸
# -------------------------
if menu == "í˜¼í•© ì•ˆì „ í™•ì¸":
    st.subheader("âš ï¸ ì„¸ì œ/ì„±ë¶„ í˜¼í•© ì•ˆì „ í™•ì¸")

    all_options = sorted({v for s in ALIASES.values() for v in s})
    selected = st.multiselect("ì„¸ì œ/ì„±ë¶„ ì„ íƒ", options=all_options, default=["ë½ìŠ¤", "ì‹ì´ˆ"])

    if st.button("í™•ì¸í•˜ê¸°"):
        keys, messages, details = check_mixture(selected)

        if keys:
            st.info("ì¸ì‹ëœ ì„±ë¶„: " + ", ".join(sorted(keys)) or "(ì—†ìŒ)")
        if messages:
            for idx, (cat, m) in enumerate(messages, 1):
                st.error(f"{idx}. {cat} â†’ {m}")
            st.markdown("### ìƒì„¸ ì„¤ëª…")
            for d in details:
                if not d:
                    continue
                with st.expander("ìì„¸íˆ ë³´ê¸°"):
                    st.write("â€¢ **ì´ìœ **:", d["why"])
                    st.write("â€¢ **ì¦ìƒ**:", d["symptoms"])
                    st.write("â€¢ **ëŒ€ì‹  ì´ë ‡ê²Œ ì‚¬ìš©í•˜ì„¸ìš”**:", d["instead"])
        else:
            st.success("íŠ¹ë³„íˆ ìœ„í—˜í•œ ì¡°í•©ì€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì œí’ˆì€ í•˜ë‚˜ì”©ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.")

# -------------------------
# í¬ì„ ê³„ì‚°
# -------------------------
elif menu == "í¬ì„ ê³„ì‚°":
    st.subheader("ğŸ§ª í¬ì„ ê³„ì‚°ê¸°")
    st.caption("ì˜ˆ: ë½ìŠ¤ 5% ì›ì•¡ìœ¼ë¡œ 0.1% ì†Œë…ì•¡ 1L ë§Œë“¤ê¸°")

    c1 = st.number_input("ì›ì•¡ ë†ë„ C1 (%)", value=5.0, step=0.1)
    c2 = st.number_input("ëª©í‘œ ë†ë„ C2 (%)", value=0.1, step=0.1)
    v2 = st.number_input("ìµœì¢… ë¶€í”¼ V2 (mL)", value=1000.0, step=50.0)

    if st.button("ê³„ì‚°í•˜ê¸°"):
        v1, solvent = dilution_calc(c1, c2, v2)
        if v1 is None:
            st.error("ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”. (C1 > C2 > 0, V2 > 0)")
        else:
            st.metric("í•„ìš”í•œ ì›ì•¡ (mL)", f"{v1:.1f}")
            st.metric("í•„ìš”í•œ ë¬¼ (mL)", f"{solvent:.1f}")
            st.caption("ì›ì•¡ì„ ë¬¼ì— ì¡°ê¸ˆì”© ë„£ì–´ ì„ì–´ì£¼ì„¸ìš”. ì‚¬ìš© í›„ í™˜ê¸°Â·í—¹êµ¼ í•„ìˆ˜!")

# -------------------------
# í‘œë©´ë³„ ê°€ì´ë“œ
# -------------------------
elif menu == "í‘œë©´ë³„ ê°€ì´ë“œ":
    st.subheader("ğŸ  í‘œë©´ë³„ ê°€ì´ë“œ")
    for surf, info in SURFACE_GUIDE.items():
        with st.expander(surf):
            st.write("âœ… ê¶Œì¥:", ", ".join(info["ê¶Œì¥"]))
            st.write("âš ï¸ ì£¼ì˜:", ", ".join(info["ì£¼ì˜"]))
            st.caption(info["ë©”ëª¨"])

st.divider()
st.caption("â€» ì´ ì•±ì€ ìƒí™œ ì•ˆì „ ì°¸ê³ ìš© ê°€ì´ë“œì…ë‹ˆë‹¤. ì‹¤ì œ ì‚¬ìš© ì‹œì—ëŠ” ì œí’ˆ ë¼ë²¨ê³¼ ì•ˆì „ ì§€ì¹¨ì„ ê¼­ í™•ì¸í•˜ì„¸ìš”.")
