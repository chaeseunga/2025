# chem_safety_app.py
# ì‹¤í–‰: streamlit run chem_safety_app.py

import streamlit as st

# =========================
# ë°ì´í„°(í‚¤ì›Œë“œ/ê·œì¹™/ì„¤ëª…)
# =========================
ALIASES = {
    "bleach": {"í‘œë°±ì œ", "ë½ìŠ¤", "ì°¨ì•„ì—¼ì†Œì‚°ë‚˜íŠ¸ë¥¨", "sodium hypochlorite", "hypochlorite"},
    "ammonia": {"ì•”ëª¨ë‹ˆì•„", "ammonia", "nh3"},
    "acid": {"ì‹ì´ˆ", "ì´ˆì‚°", "acetic acid", "êµ¬ì—°ì‚°", "citric acid", "ì—¼ì‚°", "hydrochloric acid", "hcl", "í™©ì‚°", "sulfuric acid"},
    "peroxide": {"ê³¼ì‚°í™”ìˆ˜ì†Œ", "hydrogen peroxide", "h2o2"},
    "alcohol": {"ì—íƒ„ì˜¬", "ethanol", "ipa", "isopropyl alcohol", "ì´ì†Œí”„ë¡œí•„ì•Œì½”ì˜¬", "ì†Œë…ìš© ì•Œì½”ì˜¬"},
    "quat": {"ë²¤ì˜ì½”ëŠ„ì—¼í™”ë¬¼", "benzalkonium chloride", "quat", "4ê¸‰ ì•”ëª¨ëŠ„ì—¼", "quaternary ammonium"},
    "baking_soda": {"ë² ì´í‚¹ì†Œë‹¤", "íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨", "sodium bicarbonate"},
}

# ìœ„í—˜ ì¡°í•© ê·œì¹™(í•µì‹¬ ê²½ê³  ë©”ì‹œì§€)
HAZARDOUS_RULES = {
    frozenset({"bleach", "ammonia"}): "â€˜í‘œë°±ì œ+ì•”ëª¨ë‹ˆì•„â€™ í˜¼í•©ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.",
    frozenset({"bleach", "acid"}): "â€˜í‘œë°±ì œ+ì‚°(ì‹ì´ˆ/êµ¬ì—°ì‚°/ì—¼ì‚° ë“±)â€™ í˜¼í•©ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.",
    frozenset({"bleach", "alcohol"}): "â€˜í‘œë°±ì œ+ì•Œì½”ì˜¬â€™ í˜¼í•©ì€ ìœ„í—˜í•©ë‹ˆë‹¤.",
    frozenset({"peroxide", "acid"}): "â€˜ê³¼ì‚°í™”ìˆ˜ì†Œ+ì‚°â€™ í˜¼í•©ì€ ìœ„í—˜í•©ë‹ˆë‹¤.",
    frozenset({"baking_soda", "acid"}): "â€˜ë² ì´í‚¹ì†Œë‹¤+ì‚°â€™ì€ ë°€í ìš©ê¸°ì—ì„œ ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    frozenset({"bleach", "quat"}): "â€˜í‘œë°±ì œ+4ê¸‰ì•”ëª¨ëŠ„(ì†Œë…ì œ)â€™ í˜¼í•©ì€ í”¼í•˜ì„¸ìš”.",
}

# ì‰¬ìš´ ì„¤ëª…(ì™œ ìœ„í—˜í•œê°€ Â· ì¦ìƒ Â· ì•ˆì „ ëŒ€ì•ˆ)
HAZ_DETAILS = {
    frozenset({"bleach", "ammonia"}): {
        "why": "ì„ìœ¼ë©´ â€˜í´ë¡œë¼ë¯¼â€™ ê°™ì€ ìê·¹ì„± ê°€ìŠ¤ê°€ ìƒê²¨ ëˆˆÂ·ì½” ìê·¹ê³¼ ê¸°ì¹¨, í˜¸í¡ê³¤ë€ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ëˆˆÂ·ëª© ë”°ê°€ì›€, ê¸°ì¹¨, ë©”ìŠ¤êº¼ì›€, ìˆ¨ ê°€ì¨, ì–´ì§€ëŸ¬ì›€.",
        "instead": "í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. í‘œë°±ì œë¥¼ ì¼ë‹¤ë©´ ì¶©ë¶„íˆ ë¬¼ë¡œ í—¹êµ¬ê³  í™˜ê¸°í•œ ë’¤, ë‹¤ë¥¸ ë‚  ì•”ëª¨ë‹ˆì•„ ì œí’ˆì„ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "acid"}): {
        "why": "ì„ì´ë©´ â€˜ì—¼ì†Œ ê°€ìŠ¤(Clâ‚‚)â€™ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜¸í¡ê¸°ì— ë§¤ìš° ìê·¹ì ì…ë‹ˆë‹¤.",
        "symptoms": "ëˆˆë¬¼, ì‹¬í•œ ê¸°ì¹¨, ê°€ìŠ´ ë‹µë‹µ, í˜¸í¡ ê³¤ë€(ë†’ì€ ë†ë„ëŠ” í ì†ìƒ ìœ„í—˜).",
        "instead": "í‘œë°±ì œì™€ ì‹ì´ˆÂ·êµ¬ì—°ì‚°Â·ì—¼ì‚° ê³„ì—´ì€ ì ˆëŒ€ í•¨ê»˜ ì“°ì§€ ë§ˆì„¸ìš”. í•„ìš”í•˜ë©´ ë‹¤ë¥¸ ë‚  ë”°ë¡œ ì‚¬ìš©í•˜ê³  ì‚¬ìš© í›„ ì¶©ë¶„íˆ í—¹êµ° ë’¤ í™˜ê¸°í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "alcohol"}): {
        "why": "íŠ¹ì • ì¡°ê±´ì—ì„œ ë…ì„± ë¶€ì‚°ë¬¼(ì˜ˆ: í´ë¡œë¡œí¬ë¦„)ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ë‘í†µ, ì–´ì§€ëŸ¬ì›€, ë©”ìŠ¤êº¼ì›€ ë“±(ë…¸ì¶œ ì •ë„ì— ë”°ë¼ ë‹¤ë¦„).",
        "instead": "í‘œë°±ì œ ì‚¬ìš©í•˜ëŠ” ë‚ ì—ëŠ” ì•Œì½”ì˜¬ ì œí’ˆ(ì†Œë…ìš© ì•Œì½”ì˜¬, ìœ ë¦¬ì„¸ì •ì œ ë“±)ì„ í”¼í•˜ê³ , ì„œë¡œ ë‹¤ë¥¸ ë‚ ì— ë¶„ë¦¬í•´ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"peroxide", "acid"}): {
        "why": "â€˜ê³¼ì´ˆì‚°â€™ ê°™ì€ ê°•í•œ ìê·¹Â·ë¶€ì‹ì„± ë¬¼ì§ˆì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "í”¼ë¶€Â·ëˆˆ ìê·¹, í˜¸í¡ê¸° ìê·¹.",
        "instead": "ê³¼ì‚°í™”ìˆ˜ì†Œì™€ ì‚°ì„± ì œí’ˆì€ í•¨ê»˜ ì“°ì§€ ë§ê³ , ê°ê° ì œí’ˆ ì•ˆë‚´ëŒ€ë¡œ ë‹¨ë… ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"baking_soda", "acid"}): {
        "why": "ì´ì‚°í™”íƒ„ì†Œ(COâ‚‚)ê°€ ë¹ ë¥´ê²Œ ë°œìƒí•©ë‹ˆë‹¤. ë°€í ìš©ê¸°ì—ì„œëŠ” ì••ë ¥ì´ ì˜¬ë¼ â€˜í‘â€™ íŠˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ë°€í ìƒíƒœì—ì„œ ìš©ê¸° íŒŒì†Â·íŠ€ê¹€ ìœ„í—˜.",
        "instead": "ë°€í ìš©ê¸°ì—ì„œ ì„ì§€ ë§ˆì„¸ìš”. í†µí’ë˜ëŠ” ê³³ì—ì„œ ì†ŒëŸ‰ë§Œ, ê°œë°© ìš©ê¸°ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.",
    },
    frozenset({"bleach", "quat"}): {
        "why": "ìƒí˜¸ ì‘ìš©ìœ¼ë¡œ íš¨ê³¼ê°€ ë–¨ì–´ì§€ê±°ë‚˜ ì”ë¥˜ ë°˜ì‘ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "symptoms": "ì‚´ê·  íš¨ê³¼ ì €í•˜, í‘œë©´ ì†ìƒ ê°€ëŠ¥.",
        "instead": "í•œ ë²ˆì— í•˜ë‚˜ì˜ ì œí’ˆë§Œ ì‚¬ìš©í•˜ê³ , ì‚¬ìš© í›„ ë¬¼ë¡œ ì¶©ë¶„íˆ í—¹êµ¬ì„¸ìš”.",
    },
}

SURFACE_GUIDE = {
    "ëŒ€ë¦¬ì„/ì„ì¬": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "ë¯¸ì˜¨ìˆ˜"],
        "ì£¼ì˜": ["ì‚°(ì‹ì´ˆ/êµ¬ì—°ì‚°)", "í‘œë°±ì œ"],
        "ë©”ëª¨": "ì„íšŒì§ˆ(íƒ„ì‚°ì¹¼ìŠ˜)ì´ë¼ ì‚°ì— ì•½í•©ë‹ˆë‹¤. ë°˜ì Â·ë¶€ì‹ ìœ„í—˜.",
    },
    "ëª©ì¬": {
        "ê¶Œì¥": ["ì¤‘ì„±Â·ì•½ì•Œì¹¼ë¦¬ ì„¸ì œ", "ë§ˆë¥¸ì²œ", "êµ­ì†Œ ì˜¤ì—¼ ì‹œ ì†ŒëŸ‰ ì•Œì½”ì˜¬"],
        "ì£¼ì˜": ["ê³¼ë„í•œ ìˆ˜ë¶„", "ê°•ì‚°/ê°•ì•Œì¹¼ë¦¬"],
        "ë©”ëª¨": "ì½”íŒ… ì†ìƒÂ·ë³€ìƒ‰ ì£¼ì˜. ë¬¼ê¸°ëŠ” ë°”ë¡œ ë‹¦ì•„ì£¼ì„¸ìš”.",
    },
    "ìŠ¤í…Œì¸ë¦¬ìŠ¤": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "ì§§ì€ ì‹œê°„ í¬ì„ í‘œë°±ì œ(ì´í›„ ì¦‰ì‹œ í—¹êµ¼)"],
        "ì£¼ì˜": ["ì—¼ì‚° ë“± ê°•ì‚°", "ì¥ì‹œê°„ í‘œë°±ì œ ì ‘ì´‰"],
        "ë©”ëª¨": "ì‚¬ìš© í›„ ë¬¼ë¡œ ì¶©ë¶„íˆ í—¹êµ¬ë©´ ì–¼ë£©Â·ë¶€ì‹ ì˜ˆë°©.",
    },
    "ìœ ë¦¬/íƒ€ì¼": {
        "ê¶Œì¥": ["ì¤‘ì„± ì„¸ì œ", "í¬ì„ ì‚°(ë¹„ëˆ„ë•Œ ì œê±°)", "ì•Œì½”ì˜¬"],
        "ì£¼ì˜": ["í™˜ê¸° ë¶€ì¡± ìƒíƒœì—ì„œ ì•”ëª¨ë‹ˆì•„ ê³¼ë‹¤ ì‚¬ìš©"],
        "ë©”ëª¨": "ê¸ˆì† ë¶€í’ˆ ì ‘ì´‰ ì‹œ ë¶€ì‹ ì£¼ì˜, í™˜ê¸° í•„ìˆ˜.",
    },
}

# =========================
# ìœ í‹¸ í•¨ìˆ˜
# =========================
def normalize_token(token: str) -> set:
    token = token.strip().lower()
    hits = set()
    for key, variants in ALIASES.items():
        for v in variants:
            if v.lower() in token:
                hits.add(key)
    if token in ALIASES.keys():
        hits.add(token)
    return hits

def check_mixture(items: list):
    keys = set()
    for raw in items:
        keys |= normalize_token(raw)
    messages, details = [], []
    klist = list(keys)
    for i in range(len(klist)):
        for j in range(i+1, len(klist)):
            combo = frozenset({klist[i], klist[j]})
            if combo in HAZARDOUS_RULES:
                messages.append(HAZARDOUS_RULES[combo])
                details.append(HAZ_DETAILS.get(combo))
    return keys, messages, details

def dilution_calc(c1, c2, v2):
    # c1, c2: %, v2: mL(ë˜ëŠ” ê°™ì€ ë‹¨ìœ„)
    if c1 <= 0 or c2 <= 0 or v2 <= 0 or c2 >= c1:
        return None, None
    v1 = (c2 * v2) / c1
    solvent = v2 - v1
    return v1, solvent

# =========================
# Streamlit UI
# =========================
st.set_page_config(page_title="í™”í•™ ì•ˆì „ ë„ìš°ë¯¸", page_icon="ğŸ§¹")
st.title("ğŸ§¹ í™”í•™ ì•ˆì „ ë„ìš°ë¯¸")

st.markdown(
    """
**ë¬´ì—‡ì„ í•˜ë‚˜ìš”?**  
- âŒ ì„ì´ë©´ ìœ„í—˜í•œ ì„¸ì œ ì¡°í•©ì„ ì•Œë ¤ì¤ë‹ˆë‹¤.  
- ğŸ§ª ë¬¼ì— ì–¼ë§ˆë‚˜ íƒ€ì•¼ í•˜ëŠ”ì§€(í¬ì„) ê°„ë‹¨íˆ ê³„ì‚°í•´ ì¤ë‹ˆë‹¤.  
- ğŸ  í‘œë©´(ëŒ€ë¦¬ì„Â·ëª©ì¬Â·ìŠ¤í…Œì¸ë¦¬ìŠ¤ ë“±)ì— ë§ëŠ” ì‚¬ìš© ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.  

**ê¸°ë³¸ ìˆ˜ì¹™**  
1) í•œ ë²ˆì— **í•˜ë‚˜ì˜ ì œí’ˆë§Œ** ì‚¬ìš©  
2) **í™˜ê¸°** ê¼­ í•˜ê¸°(ì°½ë¬¸ ì—´ê¸°/ì„ í’ê¸°)  
3) ì œí’ˆ **ë¼ë²¨**ì˜ â€˜í˜¼í•© ê¸ˆì§€â€™ ë¬¸êµ¬ í™•ì¸  
4) í•„ìš”í•˜ë©´ ì›ì•¡ì„ **ë¬¼ì— í¬ì„**í•´ì„œ ì‚¬ìš©
"""
)

menu = st.sidebar.radio(
    "ë©”ë‰´",
    ["í˜¼í•© ì•ˆì „ í™•ì¸", "í¬ì„ ê³„ì‚°", "í‘œë©´ë³„ ê°€ì´ë“œ", "ìì£¼ ë¬»ëŠ” ì§ˆë¬¸"]
)

# -------------------------
# 1) í˜¼í•© ì•ˆì „ í™•ì¸
# -------------------------
if menu == "í˜¼í•© ì•ˆì „ í™•ì¸":
    st.subheader("âš ï¸ ì„¸ì œ/ì„±ë¶„ í˜¼í•© ì•ˆì „ í™•ì¸")
    st.caption("ì˜ˆì‹œ: `ë½ìŠ¤, ì‹ì´ˆ` / `ê³¼ì‚°í™”ìˆ˜ì†Œ 6%, êµ¬ì—°ì‚°` / `ì•”ëª¨ë‹ˆì•„ í´ë¦¬ë„ˆ`")
    raw = st.text_input("ì„¸ì œ/ì„±ë¶„ ì…ë ¥(ì‰¼í‘œë¡œ êµ¬ë¶„)", "ë½ìŠ¤, ì‹ì´ˆ")
    if st.button("ì•ˆì „ ì²´í¬"):
        items = [x.strip() for x in raw.split(",") if x.strip()]
        keys, messages, details = check_mixture(items)

        if keys:
            st.write("ğŸ” ì¸ì‹ëœ ì„±ë¶„ í‚¤:", ", ".join(sorted(keys)) or "(ì•Œ ìˆ˜ ì—†ìŒ)")
        if messages:
            for idx, m in enumerate(messages, 1):
                st.error(f"{idx}. {m}")
            st.markdown("### ì™œ ìœ„í—˜í• ê¹Œìš”? / ëŒ€ì‹  ì–´ë–»ê²Œ í• ê¹Œìš”?")
            for d in details:
                if not d:
                    continue
                with st.expander("ìƒì„¸ ë³´ê¸°", expanded=False):
                    st.write("â€¢ **ì´ìœ **:", d["why"])
                    st.write("â€¢ **ì¦ìƒ**:", d["symptoms"])
                    st.write("â€¢ **ëŒ€ì‹  ì´ë ‡ê²Œ**:", d["instead"])
            st.info("ê¸°ë³¸ ìˆ˜ì¹™: í•œ ë²ˆì— í•˜ë‚˜ì˜ ì œí’ˆë§Œ ì‚¬ìš© Â· í™˜ê¸° Â· ì¥ê°‘/ë§ˆìŠ¤í¬ ì°©
